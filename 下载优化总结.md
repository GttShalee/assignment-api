# ä¸‹è½½ä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

1. âœ… **åŠ å¿«ä¸‹è½½é€Ÿåº¦** - ä½¿ç”¨æµå¼ä¼ è¾“ï¼Œç«‹å³å¼€å§‹ä¸‹è½½
2. âœ… **æ·»åŠ è¿›åº¦æç¤º** - æ˜¾ç¤ºä¸‹è½½è¿›åº¦æ¡ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

---

## ğŸ”§ åç«¯æ”¹åŠ¨ï¼ˆå·²å®Œæˆï¼‰

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/main/java/cn/shalee/workupload/controller/HomeworkSubmissionController.java`

### æ ¸å¿ƒæ”¹åŠ¨

#### 1. è¿”å›å€¼ä» `byte[]` æ”¹ä¸º `Resource`

**ä¹‹å‰**ï¼š
```java
public ResponseEntity<byte[]> downloadSubmissionFile(...) {
    byte[] fileContent = Files.readAllBytes(filePath);  // âŒ ä¸€æ¬¡æ€§è¯»å–åˆ°å†…å­˜
    return ResponseEntity.ok().body(fileContent);
}
```

**ç°åœ¨**ï¼š
```java
public ResponseEntity<Resource> downloadSubmissionFile(...) {
    Resource resource = new FileSystemResource(filePath);  // âœ… æµå¼ä¼ è¾“
    return ResponseEntity.ok().body(resource);
}
```

#### 2. æ·»åŠ å…³é”®å“åº”å¤´

```java
// è®¾ç½®æ–‡ä»¶å¤§å°ï¼ˆè®©å‰ç«¯å¯ä»¥è®¡ç®—è¿›åº¦ï¼‰
headers.setContentLength(fileSize);

// æ”¯æŒæ–­ç‚¹ç»­ä¼ 
headers.set("Accept-Ranges", "bytes");
```

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| 10MB æ–‡ä»¶å¼€å§‹ä¸‹è½½ | ç­‰å¾… 2-3 ç§’ | **ç«‹å³** |
| 50MB æ–‡ä»¶å¼€å§‹ä¸‹è½½ | ç­‰å¾… 10-15 ç§’ | **ç«‹å³** |
| å†…å­˜å ç”¨ | å®Œæ•´æ–‡ä»¶å¤§å° | **å‡ ä¹ä¸ºé›¶** |
| å¹¶å‘èƒ½åŠ› | å—å†…å­˜é™åˆ¶ | **æ— é™åˆ¶** |

---

## ğŸ’» å‰ç«¯éœ€è¦çš„æ”¹åŠ¨

### æ ¸å¿ƒæ”¹åŠ¨ç‚¹

#### âš ï¸ ä¸å†ä½¿ç”¨ `window.open()`

**ä¹‹å‰**ï¼š
```javascript
// âŒ ç®€å•ä½†æ— æ³•æ˜¾ç¤ºè¿›åº¦
window.open(`/api/homework-submission/submission/${id}/download`);
```

**ç°åœ¨**ï¼š
```javascript
// âœ… ä½¿ç”¨ Fetch API + è¿›åº¦è·Ÿè¸ª
await downloadWithProgress(url, (loaded, total, percentage) => {
  setProgress(percentage);  // æ›´æ–°è¿›åº¦æ¡
});
```

### å¿…é¡»å®ç°çš„ä¸¤ä¸ªå‡½æ•°

#### 1. `downloadWithProgress()` - ä¸‹è½½å¹¶è·Ÿè¸ªè¿›åº¦

```javascript
async function downloadWithProgress(url, onProgress) {
  const response = await fetch(url, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  
  const total = parseInt(response.headers.get('Content-Length'), 10);
  const fileName = getFileNameFromResponse(response);
  
  const reader = response.body.getReader();
  const chunks = [];
  let loaded = 0;
  
  // é€å—è¯»å–å¹¶æ›´æ–°è¿›åº¦
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    chunks.push(value);
    loaded += value.length;
    
    const percentage = Math.round((loaded / total) * 100);
    onProgress(loaded, total, percentage);  // å›è°ƒé€šçŸ¥è¿›åº¦
  }
  
  // åˆå¹¶å¹¶ä¸‹è½½
  const blob = new Blob(chunks);
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  a.click();
  window.URL.revokeObjectURL(url);
}
```

#### 2. `getFileNameFromResponse()` - æå–æ–‡ä»¶å

```javascript
function getFileNameFromResponse(response) {
  const contentDisposition = response.headers.get('Content-Disposition');
  if (!contentDisposition) return 'download.bin';
  
  // è§£æ UTF-8 æ–‡ä»¶å
  const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+?)(?:;|$)/);
  if (utf8Match) {
    return decodeURIComponent(utf8Match[1]);
  }
  
  // è§£æ ASCII æ–‡ä»¶å
  const asciiMatch = contentDisposition.match(/filename="?([^";\n]+)"?/);
  if (asciiMatch) {
    return asciiMatch[1];
  }
  
  return 'download.bin';
}
```

---

## ğŸ“± UI ç»„ä»¶ç¤ºä¾‹

### React + Ant Design

```jsx
function DownloadButton({ submissionId }) {
  const [downloading, setDownloading] = useState(false);
  const [progress, setProgress] = useState(0);
  
  const handleDownload = async () => {
    setDownloading(true);
    
    await downloadWithProgress(
      `/api/homework-submission/submission/${submissionId}/download`,
      (loaded, total, percentage) => {
        setProgress(percentage);  // æ›´æ–°è¿›åº¦æ¡
      }
    );
    
    message.success('ä¸‹è½½æˆåŠŸï¼');
    setDownloading(false);
  };
  
  return (
    <div>
      <Button loading={downloading} onClick={handleDownload}>
        ä¸‹è½½ä½œä¸š
      </Button>
      {downloading && <Progress percent={progress} />}
    </div>
  );
}
```

### åŸç”Ÿ HTML/CSS

```html
<button id="downloadBtn">ä¸‹è½½ä½œä¸š</button>
<div class="progress-bar">
  <div class="progress-fill" id="progressFill">0%</div>
</div>

<script>
document.getElementById('downloadBtn').onclick = async () => {
  await downloadWithProgress(url, (loaded, total, percentage) => {
    const fill = document.getElementById('progressFill');
    fill.style.width = percentage + '%';
    fill.textContent = percentage + '%';
  });
};
</script>
```

---

## ğŸ“Š ä¸‰ä¸ªä¸‹è½½æ¥å£çš„å¯¹æ¯”

| æ¥å£ | åç«¯ä¼˜åŒ– | æ¨èå‰ç«¯æ–¹å¼ |
|------|----------|-------------|
| `/submission/{id}/download` | âœ… æµå¼ä¼ è¾“ | Fetch + è¿›åº¦æ¡ |
| `/my/{homeworkId}/download` | âœ… æµå¼ä¼ è¾“ | Fetch + è¿›åº¦æ¡ |
| `/homework/{id}/download-all` | âš ï¸ ZIPæ‰“åŒ… | Loading æç¤ºå³å¯ |

> **æ³¨æ„**ï¼šZIP æ‰“åŒ…ä¸‹è½½å› ä¸ºéœ€è¦å…ˆæ‰“åŒ…ï¼Œæ‰€ä»¥åªèƒ½æ˜¾ç¤º Loadingï¼Œæ— æ³•æ˜¾ç¤ºç²¾ç¡®è¿›åº¦ã€‚

---

## âœ… éªŒæ”¶æ ‡å‡†

### åç«¯éªŒæ”¶
- âœ… ç‚¹å‡»ä¸‹è½½å**ç«‹å³**å¼€å§‹ä¸‹è½½ï¼ˆä¸ç­‰å¾…ï¼‰
- âœ… å¤§æ–‡ä»¶ä¸‹è½½ä¸å ç”¨æœåŠ¡å™¨å†…å­˜
- âœ… å“åº”å¤´åŒ…å« `Content-Length`
- âœ… å“åº”å¤´åŒ…å« `Accept-Ranges: bytes`

### å‰ç«¯éªŒæ”¶
- âœ… ä¸‹è½½æ—¶æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆ0% â†’ 100%ï¼‰
- âœ… è¿›åº¦æ¡å®æ—¶æ›´æ–°
- âœ… ä¸‹è½½å®Œæˆåè‡ªåŠ¨è§¦å‘ä¿å­˜
- âœ… æ–‡ä»¶åå’Œæ‰©å±•åæ­£ç¡®ï¼ˆ.docx, .pdfç­‰ï¼‰
- âœ… é”™è¯¯æç¤ºå‹å¥½ï¼ˆ404/403/500ï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### åç«¯
1. é‡æ–°ç¼–è¯‘ï¼š`./gradlew build`
2. éƒ¨ç½²æ–°çš„ JAR æ–‡ä»¶
3. é‡å¯æœåŠ¡

### å‰ç«¯
1. æ·»åŠ  `downloadWithProgress()` å‡½æ•°
2. æ·»åŠ  `getFileNameFromResponse()` å‡½æ•°
3. ä¿®æ”¹ä¸‹è½½æŒ‰é’®ï¼Œä½¿ç”¨æ–°çš„ä¸‹è½½æ–¹å¼
4. æ·»åŠ è¿›åº¦æ¡ UI ç»„ä»¶
5. æµ‹è¯•å„ç§æ–‡ä»¶å¤§å°çš„ä¸‹è½½

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šè¿›åº¦æ¡ä¸€ç›´æ˜¾ç¤º0%
**åŸå› **ï¼šåç«¯æ²¡æœ‰è®¾ç½® `Content-Length`  
**è§£å†³**ï¼šæ£€æŸ¥åç«¯ä»£ç æ˜¯å¦å·²æ›´æ–°

### é—®é¢˜2ï¼šä¸‹è½½çš„æ–‡ä»¶æ‰©å±•åé”™è¯¯
**åŸå› **ï¼š`getFileNameFromResponse()` è§£æå¤±è´¥  
**è§£å†³**ï¼šæ£€æŸ¥å“åº”å¤´ `Content-Disposition` æ ¼å¼

### é—®é¢˜3ï¼šå¤§æ–‡ä»¶ä¸‹è½½è¿˜æ˜¯å¾ˆæ…¢
**åŸå› **ï¼šç½‘ç»œå¸¦å®½é—®é¢˜ï¼Œä¸æ˜¯ä»£ç é—®é¢˜  
**è§£å†³**ï¼šè¿™æ˜¯æ­£å¸¸çš„ï¼Œè¿›åº¦æ¡è®©ç”¨æˆ·çŸ¥é“åœ¨ä¸‹è½½å³å¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- è¯¦ç»†å®ç°ï¼š`ä¸‹è½½ä¼˜åŒ–-å‰ç«¯å¯¹æ¥æ–‡æ¡£.md`
- åç«¯ä»£ç ï¼š`src/main/java/cn/shalee/workupload/controller/HomeworkSubmissionController.java`

**æ–‡æ¡£æ›´æ–°æ—¥æœŸ**ï¼š2025-10-21

