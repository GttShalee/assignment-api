# ä¸‹è½½ä¼˜åŒ– - å‰ç«¯å¯¹æ¥æ–‡æ¡£

## ğŸ“Œ åç«¯ä¼˜åŒ–è¯´æ˜

### âœ… å·²å®Œæˆçš„ä¼˜åŒ–

1. **æµå¼ä¼ è¾“**ï¼šä½¿ç”¨ `FileSystemResource` æ›¿ä»£ `byte[]`
   - âœ… ä¸å†ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜
   - âœ… è¾¹è¯»è¾¹ä¼ ï¼Œç«‹å³å¼€å§‹ä¸‹è½½
   - âœ… æ”¯æŒå¤§æ–‡ä»¶ä¸‹è½½ï¼ˆä¸å—å†…å­˜é™åˆ¶ï¼‰
   - âœ… æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼ˆ`Accept-Ranges: bytes`ï¼‰

2. **å“åº”å¤´ä¼˜åŒ–**ï¼š
   - âœ… æ·»åŠ  `Content-Length`ï¼šè®©å‰ç«¯å¯ä»¥è®¡ç®—ä¸‹è½½è¿›åº¦
   - âœ… æ·»åŠ  `Accept-Ranges`ï¼šæ”¯æŒæ–­ç‚¹ç»­ä¼ 
   - âœ… ä¿æŒæ–‡ä»¶åå’Œæ‰©å±•åæ­£ç¡®

### æ€§èƒ½æå‡

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| 10MB æ–‡ä»¶ | ç­‰å¾… 2-3 ç§’åå¼€å§‹ä¸‹è½½ | **ç«‹å³å¼€å§‹**ä¸‹è½½ |
| 50MB æ–‡ä»¶ | ç­‰å¾… 10-15 ç§’åå¼€å§‹ä¸‹è½½ | **ç«‹å³å¼€å§‹**ä¸‹è½½ |
| å†…å­˜å ç”¨ | æ¯ä¸ªä¸‹è½½å ç”¨å®Œæ•´æ–‡ä»¶å¤§å° | **å‡ ä¹ä¸ºé›¶** |
| å¹¶å‘ä¸‹è½½ | 3ä¸ª50MBæ–‡ä»¶=150MBå†…å­˜ | **å‡ ä¹ä¸å ç”¨å†…å­˜** |

---

## ğŸ¨ å‰ç«¯å®ç°ï¼šå¸¦è¿›åº¦æ¡çš„ä¸‹è½½

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ Fetch API + è¿›åº¦æ¡ï¼ˆæ¨èï¼‰âœ…

è¿™æ˜¯æœ€å®Œæ•´çš„æ–¹æ¡ˆï¼Œæ”¯æŒæ˜¾ç¤ºç™¾åˆ†æ¯”è¿›åº¦ã€‚

```javascript
/**
 * å¸¦è¿›åº¦æ¡çš„æ–‡ä»¶ä¸‹è½½
 * @param {string} url - ä¸‹è½½URL
 * @param {Function} onProgress - è¿›åº¦å›è°ƒ (loaded, total, percentage)
 * @returns {Promise<void>}
 */
async function downloadWithProgress(url, onProgress) {
  try {
    const response = await fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      }
    });
    
    if (!response.ok) {
      throw new Error(`ä¸‹è½½å¤±è´¥: ${response.status}`);
    }
    
    // è·å–æ–‡ä»¶æ€»å¤§å°
    const contentLength = response.headers.get('Content-Length');
    const total = parseInt(contentLength, 10);
    
    // è·å–æ–‡ä»¶å
    const fileName = getFileNameFromResponse(response);
    
    // ä½¿ç”¨ ReadableStream è¯»å–æ•°æ®å¹¶è·Ÿè¸ªè¿›åº¦
    const reader = response.body.getReader();
    const chunks = [];
    let loaded = 0;
    
    while (true) {
      const { done, value } = await reader.read();
      
      if (done) break;
      
      chunks.push(value);
      loaded += value.length;
      
      // è°ƒç”¨è¿›åº¦å›è°ƒ
      if (onProgress && total) {
        const percentage = Math.round((loaded / total) * 100);
        onProgress(loaded, total, percentage);
      }
    }
    
    // åˆå¹¶æ‰€æœ‰å—
    const blob = new Blob(chunks);
    
    // è§¦å‘ä¸‹è½½
    const downloadUrl = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(downloadUrl);
    
    console.log(`ä¸‹è½½å®Œæˆ: ${fileName}`);
  } catch (error) {
    console.error('ä¸‹è½½å¤±è´¥:', error);
    throw error;
  }
}

/**
 * ä»å“åº”å¤´ä¸­æå–æ–‡ä»¶å
 */
function getFileNameFromResponse(response) {
  const contentDisposition = response.headers.get('Content-Disposition');
  if (!contentDisposition) return 'download.bin';
  
  const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+?)(?:;|$)/);
  if (utf8Match) {
    return decodeURIComponent(utf8Match[1]);
  }
  
  const asciiMatch = contentDisposition.match(/filename="?([^";\n]+)"?/);
  if (asciiMatch) {
    return asciiMatch[1];
  }
  
  return 'download.bin';
}
```

### æ–¹æ¡ˆ 2ï¼šç®€å•ç‰ˆ - ä½¿ç”¨ Loading æç¤ºï¼ˆæ¬¡é€‰ï¼‰

å¦‚æœä¸éœ€è¦ç²¾ç¡®è¿›åº¦ï¼Œåªæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼š

```javascript
/**
 * ç®€å•çš„ä¸‹è½½ï¼ˆå¸¦ Loading æç¤ºï¼‰
 * @param {string} url - ä¸‹è½½URL
 * @param {Function} showLoading - æ˜¾ç¤ºåŠ è½½å‡½æ•°
 * @param {Function} hideLoading - éšè—åŠ è½½å‡½æ•°
 */
async function downloadWithLoading(url, showLoading, hideLoading) {
  const loadingId = showLoading('æ­£åœ¨ä¸‹è½½...');
  
  try {
    const response = await fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      }
    });
    
    if (!response.ok) {
      throw new Error('ä¸‹è½½å¤±è´¥');
    }
    
    const fileName = getFileNameFromResponse(response);
    const blob = await response.blob();
    
    const downloadUrl = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(downloadUrl);
    
    hideLoading(loadingId);
    console.log('ä¸‹è½½æˆåŠŸ');
  } catch (error) {
    hideLoading(loadingId);
    console.error('ä¸‹è½½å¤±è´¥:', error);
    alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}
```

---

## ğŸ“± React å®Œæ•´ç¤ºä¾‹

### React + Ant Designï¼šå¸¦è¿›åº¦æ¡çš„ä¸‹è½½

```jsx
import React, { useState } from 'react';
import { Button, Progress, message, Modal } from 'antd';
import { DownloadOutlined } from '@ant-design/icons';

function DownloadButton({ submissionId, buttonText = 'ä¸‹è½½ä½œä¸š' }) {
  const [downloading, setDownloading] = useState(false);
  const [progress, setProgress] = useState(0);
  const [showProgress, setShowProgress] = useState(false);
  
  const handleDownload = async () => {
    setDownloading(true);
    setShowProgress(true);
    setProgress(0);
    
    try {
      await downloadWithProgress(
        `/api/homework-submission/submission/${submissionId}/download`,
        (loaded, total, percentage) => {
          setProgress(percentage);
        }
      );
      
      message.success('ä¸‹è½½æˆåŠŸï¼');
      setShowProgress(false);
    } catch (error) {
      message.error('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
      console.error(error);
    } finally {
      setDownloading(false);
    }
  };
  
  return (
    <>
      <Button
        type="primary"
        icon={<DownloadOutlined />}
        onClick={handleDownload}
        loading={downloading}
      >
        {buttonText}
      </Button>
      
      {/* ä¸‹è½½è¿›åº¦å¯¹è¯æ¡† */}
      <Modal
        title="ä¸‹è½½ä¸­"
        open={showProgress}
        footer={null}
        closable={false}
        maskClosable={false}
      >
        <Progress percent={progress} status="active" />
        <p style={{ marginTop: 16, textAlign: 'center' }}>
          {progress < 100 ? 'æ­£åœ¨ä¸‹è½½ï¼Œè¯·ç¨å€™...' : 'ä¸‹è½½å®Œæˆï¼'}
        </p>
      </Modal>
    </>
  );
}

/**
 * å¸¦è¿›åº¦è·Ÿè¸ªçš„ä¸‹è½½å‡½æ•°
 */
async function downloadWithProgress(url, onProgress) {
  const response = await fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('token')
    }
  });
  
  if (!response.ok) {
    throw new Error(`ä¸‹è½½å¤±è´¥: ${response.status}`);
  }
  
  const contentLength = response.headers.get('Content-Length');
  const total = parseInt(contentLength, 10);
  const fileName = getFileNameFromResponse(response);
  
  const reader = response.body.getReader();
  const chunks = [];
  let loaded = 0;
  
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    chunks.push(value);
    loaded += value.length;
    
    if (onProgress && total) {
      const percentage = Math.round((loaded / total) * 100);
      onProgress(loaded, total, percentage);
    }
  }
  
  const blob = new Blob(chunks);
  const downloadUrl = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = downloadUrl;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(downloadUrl);
}

function getFileNameFromResponse(response) {
  const contentDisposition = response.headers.get('Content-Disposition');
  if (!contentDisposition) return 'download.bin';
  
  const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+?)(?:;|$)/);
  if (utf8Match) {
    return decodeURIComponent(utf8Match[1]);
  }
  
  const asciiMatch = contentDisposition.match(/filename="?([^";\n]+)"?/);
  if (asciiMatch) {
    return asciiMatch[1];
  }
  
  return 'download.bin';
}

export default DownloadButton;
```

### ä½¿ç”¨ç¤ºä¾‹

```jsx
// åœ¨å­¦ç”Ÿä½œä¸šæäº¤åˆ—è¡¨ä¸­ä½¿ç”¨
<DownloadButton 
  submissionId={submission.id} 
  buttonText="ä¸‹è½½ä½œä¸š" 
/>

// ä¸‹è½½è‡ªå·±çš„ä½œä¸š
<DownloadButton 
  url={`/api/homework-submission/my/${homeworkId}/download`}
  buttonText="ä¸‹è½½æˆ‘çš„ä½œä¸š"
/>
```

---

## ğŸ¨ Vue 3 å®Œæ•´ç¤ºä¾‹

```vue
<template>
  <div>
    <a-button 
      type="primary" 
      :loading="downloading"
      @click="handleDownload"
    >
      <DownloadOutlined />
      {{ buttonText }}
    </a-button>
    
    <!-- ä¸‹è½½è¿›åº¦å¯¹è¯æ¡† -->
    <a-modal
      v-model:open="showProgress"
      title="ä¸‹è½½ä¸­"
      :footer="null"
      :closable="false"
      :maskClosable="false"
    >
      <a-progress :percent="progress" status="active" />
      <p style="margin-top: 16px; text-align: center;">
        {{ progress < 100 ? 'æ­£åœ¨ä¸‹è½½ï¼Œè¯·ç¨å€™...' : 'ä¸‹è½½å®Œæˆï¼' }}
      </p>
    </a-modal>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { message } from 'ant-design-vue';
import { DownloadOutlined } from '@ant-design/icons-vue';

const props = defineProps({
  submissionId: {
    type: Number,
    required: true
  },
  buttonText: {
    type: String,
    default: 'ä¸‹è½½ä½œä¸š'
  }
});

const downloading = ref(false);
const progress = ref(0);
const showProgress = ref(false);

const handleDownload = async () => {
  downloading.value = true;
  showProgress.value = true;
  progress.value = 0;
  
  try {
    await downloadWithProgress(
      `/api/homework-submission/submission/${props.submissionId}/download`,
      (loaded, total, percentage) => {
        progress.value = percentage;
      }
    );
    
    message.success('ä¸‹è½½æˆåŠŸï¼');
    showProgress.value = false;
  } catch (error) {
    message.error('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
    console.error(error);
  } finally {
    downloading.value = false;
  }
};

async function downloadWithProgress(url, onProgress) {
  const response = await fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('token')
    }
  });
  
  if (!response.ok) {
    throw new Error(`ä¸‹è½½å¤±è´¥: ${response.status}`);
  }
  
  const contentLength = response.headers.get('Content-Length');
  const total = parseInt(contentLength, 10);
  const fileName = getFileNameFromResponse(response);
  
  const reader = response.body.getReader();
  const chunks = [];
  let loaded = 0;
  
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    chunks.push(value);
    loaded += value.length;
    
    if (onProgress && total) {
      const percentage = Math.round((loaded / total) * 100);
      onProgress(loaded, total, percentage);
    }
  }
  
  const blob = new Blob(chunks);
  const downloadUrl = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = downloadUrl;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(downloadUrl);
}

function getFileNameFromResponse(response) {
  const contentDisposition = response.headers.get('Content-Disposition');
  if (!contentDisposition) return 'download.bin';
  
  const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+?)(?:;|$)/);
  if (utf8Match) {
    return decodeURIComponent(utf8Match[1]);
  }
  
  const asciiMatch = contentDisposition.match(/filename="?([^";\n]+)"?/);
  if (asciiMatch) {
    return asciiMatch[1];
  }
  
  return 'download.bin';
}
</script>
```

---

## ğŸ”¥ åŸç”Ÿ JavaScript ç¤ºä¾‹ï¼ˆæ— æ¡†æ¶ï¼‰

```html
<!DOCTYPE html>
<html>
<head>
  <title>æ–‡ä»¶ä¸‹è½½ç¤ºä¾‹</title>
  <style>
    .download-container {
      padding: 20px;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background-color: #f0f0f0;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
      display: none;
    }
    
    .progress-bar.active {
      display: block;
    }
    
    .progress-fill {
      height: 100%;
      background-color: #1890ff;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    button {
      padding: 10px 20px;
      background-color: #1890ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="download-container">
    <button id="downloadBtn">ä¸‹è½½ä½œä¸š</button>
    
    <div id="progressBar" class="progress-bar">
      <div id="progressFill" class="progress-fill">0%</div>
    </div>
    
    <p id="statusText"></p>
  </div>

  <script>
    const downloadBtn = document.getElementById('downloadBtn');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const statusText = document.getElementById('statusText');
    
    downloadBtn.addEventListener('click', async () => {
      const submissionId = 6; // ç¤ºä¾‹ID
      
      downloadBtn.disabled = true;
      progressBar.classList.add('active');
      statusText.textContent = 'æ­£åœ¨ä¸‹è½½...';
      
      try {
        await downloadWithProgress(
          `/api/homework-submission/submission/${submissionId}/download`,
          (loaded, total, percentage) => {
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage + '%';
          }
        );
        
        statusText.textContent = 'ä¸‹è½½æˆåŠŸï¼';
        setTimeout(() => {
          progressBar.classList.remove('active');
          statusText.textContent = '';
        }, 2000);
      } catch (error) {
        statusText.textContent = 'ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
        console.error(error);
      } finally {
        downloadBtn.disabled = false;
      }
    });
    
    async function downloadWithProgress(url, onProgress) {
      const response = await fetch(url, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      if (!response.ok) {
        throw new Error(`ä¸‹è½½å¤±è´¥: ${response.status}`);
      }
      
      const contentLength = response.headers.get('Content-Length');
      const total = parseInt(contentLength, 10);
      const fileName = getFileNameFromResponse(response);
      
      const reader = response.body.getReader();
      const chunks = [];
      let loaded = 0;
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        chunks.push(value);
        loaded += value.length;
        
        if (onProgress && total) {
          const percentage = Math.round((loaded / total) * 100);
          onProgress(loaded, total, percentage);
        }
      }
      
      const blob = new Blob(chunks);
      const downloadUrl = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = downloadUrl;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(downloadUrl);
    }
    
    function getFileNameFromResponse(response) {
      const contentDisposition = response.headers.get('Content-Disposition');
      if (!contentDisposition) return 'download.bin';
      
      const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+?)(?:;|$)/);
      if (utf8Match) {
        return decodeURIComponent(utf8Match[1]);
      }
      
      const asciiMatch = contentDisposition.match(/filename="?([^";\n]+)"?/);
      if (asciiMatch) {
        return asciiMatch[1];
      }
      
      return 'download.bin';
    }
  </script>
</body>
</html>
```

---

## ğŸ“Š ä¸‰ç§ä¸‹è½½æ¥å£çš„é€‚ç”¨åœºæ™¯

| æ¥å£ | æ¨èæ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| `/submission/{id}/download` | Fetch + è¿›åº¦æ¡ | å•ä¸ªæ–‡ä»¶ï¼Œé€‚åˆæ˜¾ç¤ºç²¾ç¡®è¿›åº¦ |
| `/my/{homeworkId}/download` | Fetch + è¿›åº¦æ¡ | å•ä¸ªæ–‡ä»¶ï¼Œé€‚åˆæ˜¾ç¤ºç²¾ç¡®è¿›åº¦ |
| `/homework/{id}/download-all` | Loading æç¤º | ZIPæ‰“åŒ…éœ€è¦æ—¶é—´ï¼Œæ˜¾ç¤º Loading å³å¯ |

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. **ä¸å†ä½¿ç”¨ `window.open()`**

è™½ç„¶ `window.open()` æœ€ç®€å•ï¼Œä½†**æ— æ³•æ˜¾ç¤ºè¿›åº¦**ã€‚å»ºè®®ï¼š
- âŒ å°æ–‡ä»¶ï¼ˆ<5MBï¼‰ï¼šå¯ä»¥ç»§ç»­ä½¿ç”¨ `window.open()`
- âœ… å¤§æ–‡ä»¶ï¼ˆ>5MBï¼‰ï¼š**å¿…é¡»**ä½¿ç”¨ Fetch + è¿›åº¦æ¡

### 2. **æµè§ˆå™¨å…¼å®¹æ€§**

`ReadableStream` API åœ¨ç°ä»£æµè§ˆå™¨ä¸­æ”¯æŒè‰¯å¥½ï¼š
- âœ… Chrome 52+
- âœ… Firefox 65+
- âœ… Safari 10.1+
- âœ… Edge 79+

### 3. **æ–‡ä»¶å¤§å°æ˜¾ç¤º**

å¯ä»¥åœ¨è¿›åº¦æ¡ä¸‹æ˜¾ç¤ºå·²ä¸‹è½½å¤§å°ï¼š

```javascript
function formatBytes(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// ä½¿ç”¨
onProgress(loaded, total, percentage) {
  setProgress(percentage);
  setStatus(`${formatBytes(loaded)} / ${formatBytes(total)}`);
}
```

### 4. **é”™è¯¯å¤„ç†**

```javascript
try {
  await downloadWithProgress(url, onProgress);
} catch (error) {
  if (error.message.includes('404')) {
    message.error('æ–‡ä»¶ä¸å­˜åœ¨');
  } else if (error.message.includes('403')) {
    message.error('æƒé™ä¸è¶³');
  } else {
    message.error('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}
```

---

## ğŸ¯ å‰ç«¯éœ€è¦åšçš„æ”¹åŠ¨æ€»ç»“

### å¿…é¡»æ”¹åŠ¨ âœ…

1. **ä½¿ç”¨ Fetch API æ›¿ä»£ `window.open()`**ï¼ˆå¤§æ–‡ä»¶ä¸‹è½½ï¼‰
2. **æ·»åŠ è¿›åº¦æ¡ç»„ä»¶**
3. **å®ç° `downloadWithProgress()` å‡½æ•°**
4. **å®ç° `getFileNameFromResponse()` å‡½æ•°**

### å¯é€‰æ”¹åŠ¨ ğŸ”¸

1. æ˜¾ç¤ºæ–‡ä»¶å¤§å°ï¼ˆ`formatBytes()`ï¼‰
2. æ˜¾ç¤ºä¸‹è½½é€Ÿåº¦
3. æ”¯æŒå–æ¶ˆä¸‹è½½
4. æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼ˆéœ€è¦é¢å¤–å¼€å‘ï¼‰

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»åç«¯å¼€å‘å›¢é˜Ÿã€‚

**æ–‡æ¡£æ›´æ–°æ—¥æœŸ**ï¼š2025-10-21

